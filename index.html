<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOP calculator</title>
    <link rel="stylesheet" href="calc.css">
</head>
<body>
    <script>
        // Functions for the operations
        const add = (a, b) => a + b;
        const sub = (a, b) => a - b;
        const mul = (a, b) => a * b;
        const div = (a, b) => a / b;
        const operate = (opp, a, b) => {
            switch(opp){
                case '+':
                    return add(a, b);
                case '-':
                    return sub(a, b);
                case '*':
                    return mul(a, b);
                case '/':
                    return div(a, b);
            }
        }
        // main box
        const calculatorEl = document.createElement('div');
        calculatorEl.setAttribute('id', 'calculator');
        document.body.appendChild(calculatorEl);
        // display box
        const displayEl = document.createElement('div');
        displayEl.setAttribute('id', 'display');
        calculatorEl.appendChild(displayEl);
        // buttons box 
        const buttonsBox = document.createElement('div');
        buttonsBox.setAttribute('id', 'buttonsBox');
        calculatorEl.appendChild(buttonsBox);
        // top buttons box
        const symbolsTopContainer = document.createElement('div');
        symbolsTopContainer.setAttribute('id', 'symbolsTop');
        buttonsBox.appendChild(symbolsTopContainer);
        // bottom buttons box
        const botButtons = document.createElement('div');
        botButtons.setAttribute('id', 'botButtons');
        buttonsBox.appendChild(botButtons);
        // symbols box on the right
        const symbolsContainer = document.createElement('div');
        symbolsContainer.setAttribute('id', 'symbolsContainer');
        botButtons.appendChild(symbolsContainer);
        // numbers box
        const numContainer = document.createElement('div');
        numContainer.setAttribute('id', 'numContainer');
        botButtons.appendChild(numContainer);
        // symbols Array
        const symbolsArray = [ '-', '+', 'enter', '<'];
        const symbolsArray2 = ['C', '=', '/', '*']
        // create operator buttons and append to symbols box
        for(e of symbolsArray){
            let symbolButton = document.createElement('button');
            symbolButton.setAttribute('class', 'symbolButtons rightButtons');
            symbolButton.setAttribute('id', `${e}`);
            symbolButton.textContent = `${e}`;
            symbolsContainer.appendChild(symbolButton);
        }

        for(e of symbolsArray2){
            let symbolButton = document.createElement('button');
            symbolButton.setAttribute('class', 'symbolButtons');
            symbolButton.setAttribute('id', `${e}`);
            symbolButton.textContent = `${e}`;
            symbolsTopContainer.appendChild(symbolButton);
        }

        // create number buttons and append to numbers box
        for(i = 9; i > 0; i--){
            let numButton = document.createElement('button');
            numButton.setAttribute('class', 'numButtons');
            numButton.setAttribute('id', i);
            numButton.textContent = i;
            numContainer.appendChild(numButton);
        }
        let zeroButton = document.createElement('button');
        zeroButton.setAttribute('class', 'numButtons zero');
        zeroButton.setAttribute('id', '0');
        zeroButton.textContent = '0';
        let decimalButton = document.createElement('button');
        decimalButton.setAttribute('class', 'numButtons decimal');
        decimalButton.setAttribute('id', '.');
        decimalButton.textContent = '.';

        numContainer.appendChild(decimalButton);
        numContainer.appendChild(zeroButton);

        // Declare useful variables with initial values
        let displayValue = [];
        let firstNum = null;
        let operator = null;
        let secondNum = null;
        let displayIsInfinity = false;
        let nanMessage = "Woh woh woh! You'r probably trying to multiply Infinity by 0 or divide 0 by 0... " + 
                         "Those operations are not supported by this calculator!" + "\n" + 
                         "I will clear the display and you can keep going ;) " + "\n" + 
                         "Thanks for your understanding :)"

        // Reset variables
        function clear(){
            displayValue.length = 0;
            firstNum = null;
            operator = null;
            secondNum = null;
        }
        // Push the result of the display
        function equal(){
            if (operator === null) return;
            let oppIndex = displayValue.indexOf(operator);
            firstNum = displayValue.slice(0, oppIndex).join('');
            secondNum = displayValue.slice(oppIndex + 1).join('');
            let result = Math.round((operate(operator[0], +firstNum, +secondNum) + Number.EPSILON) * 1000) / 1000;
            clear();
            displayValue.push(result);
        }
        // Erase the last character on the display
        function backspace(){
            if (displayValue.length === 1 && displayValue[0] !== 0){
                let num = displayValue[0].toString();
                clear();
                displayValue.push(Number(num.slice(0, -1)));
            } else {
                displayValue = displayValue.slice(0, -1);
            }
            if(!displayValue.includes(operator)){
                operator = null;
            }
        };

        function decimal(){
            let oppIndex = displayValue.indexOf(operator);
            if (operator === null && (displayValue.includes('.') || displayValue[0].toString().includes('.')) ||
                operator !== null && displayValue.slice(oppIndex).includes('.')) {
                return;
            }
            displayValue.push('.')
        }

        // Get all buttons
        let calcButtons = buttonsBox.querySelectorAll('button');
        // Remove Hover after transition end
        let removeHover = e => e.target.classList.remove('hover');
        calcButtons.forEach(button => button.addEventListener('transitionend', removeHover));

        // Add a click functionality for each button
        calcButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                if(displayIsInfinity){
                    switch(button.id){
                        case 'C':
                        case '+':
                        case '-':
                        case '*':
                        case '/':
                        case 'enter':
                        case '=':
                            console.log('tranquilo');
                            displayIsInfinity = false;
                            break;
                        default:
                            return;
                    }
                }    
                switch(button.id){
                    case 'C':
                        clear();
                        break;
                    case '=':
                    case 'enter':
                        equal();
                        break;
                    case '+':
                    case '-':
                    case '*':
                    case '/':
                        if(operator === null){
                            operator = button.id;
                            displayValue.push(operator);
                        } else {
                            equal();
                            operator = button.id;
                            displayValue.push(operator);
                        }
                        break;    
                    case '<':
                        backspace();
                        break;
                    case '.':
                        decimal();           
                        break;
                    default:
                        if(displayValue[0] == 0 && displayValue.length === 1 && button.id !== '.'){
                            displayValue.length = 0;
                        }
                        console.log(button.id);
                        displayValue.push(button.id);   
                }
                displayEl.textContent = displayValue.join('');
                if(displayValue[0] === Infinity && displayValue.length === 1) displayIsInfinity = true;
                if(displayEl.textContent.includes('NaN')) {
                    alert(nanMessage);
                    clear();
                    displayEl.textContent = '';
                }
            });
        });

        // add keyboard support
        document.addEventListener('keydown', (e) => {
            if(displayValue.length > 16 && e.key !== 'C' && e.key !== 'Clear' && e.key !== 'Backspace'){
                return;
            }
            if(displayValue[0] == 0 && displayValue.length === 1 && e.key !== '.'){
                displayValue.length = 0;
            } else if(operator.length == 1 && displayValue[firstNum.length + 1] == 0){
                console.log(displayValue);
                displayValue = displayValue.slice(0, -1)
            }
            switch(e.key){
                case 'Backspace':
                    document.getElementById('<').classList.add('hover');
                    backspace();
                    break;
                case '=':
                    document.getElementById('=').classList.add('hover');
                    let result = equal();
                    clear();
                    displayValue.push(result
                    );
                    break;
                case 'Enter':
                    document.getElementById('enter').classList.add('hover');
                    equal();
                    break;
                case 'C':
                case 'Clear':
                    document.getElementById('C').classList.add('hover')
                    clear();
                    break;
                case '.':
                    document.getElementById(e.key).classList.add('hover');
                    decimal();
                    break;
                case '+':
                case '-':
                case '*':
                case '/':
                    document.getElementById(e.key).classList.add('hover');
                    operator.push(e.key);
                    displayValue.push(e.key);
                    operation();
                    break;
                default:
                    if(isNaN(e.key)){
                        return;
                    }
                    displayValue.push(e.key);
                    document.getElementById(e.key).classList.add('hover');
            }
            let result = displayValue.join('');
            displayEl.textContent = result;
        });

    </script>
</body>
</html>