<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOP calculator</title>
    <link rel="stylesheet" href="calc.css">
</head>
<body>
    <script>
        // Functions for the operations
        const add = (a, b) => a + b;
        const sub = (a, b) => a - b;
        const mul = (a, b) => a * b;
        const div = (a, b) => a / b;
        const operate = (opp, a, b) => {
            switch(opp){
                case '+':
                    return add(a, b);
                case '-':
                    return sub(a, b);
                case '*':
                    return mul(a, b);
                case '/':
                    return div(a, b);
            }
        }
        // main box
        const calculatorEl = document.createElement('div');
        calculatorEl.setAttribute('id', 'calculator');
        document.body.appendChild(calculatorEl);
        // display box
        const displayEl = document.createElement('div');
        displayEl.setAttribute('id', 'display');
        calculatorEl.appendChild(displayEl);
        // buttons box
        const btnContainer = document.createElement('div');
        btnContainer.setAttribute('id', 'buttonContainer');
        calculatorEl.appendChild(btnContainer);
        // symbols box
        const symbolsContainer = document.createElement('div');
        symbolsContainer.setAttribute('id', 'symbolsContainer');
        btnContainer.appendChild(symbolsContainer);
        // numbers box
        const numContainer = document.createElement('div');
        numContainer.setAttribute('id', 'numContainer');
        btnContainer.appendChild(numContainer);
        // symbols Array
        const symbolsArray = ['+', '-', '*', '/', '=', 'C', '<'];
        // create operator buttons and append to symbols box
        for(e of symbolsArray){
            let symbolButton = document.createElement('button');
            symbolButton.setAttribute('class', 'symbolButtons');
            symbolButton.setAttribute('id', `${e}`);
            symbolButton.textContent = `${e}`;
            symbolsContainer.appendChild(symbolButton);
        }
        let symbols = symbolsContainer.querySelectorAll('.symbolButtons')
        symbols.forEach(symbol => {
            if(symbol.id !== '=' && symbol.id !== 'C'){
                symbol.classList.add('operators')
            }
        });
        // create number buttons and append to numbers box
        for(i = 9; i > 0; i--){
            let numButton = document.createElement('button');
            numButton.setAttribute('class', 'numButtons');
            numButton.setAttribute('id', i);
            numButton.textContent = i;
            numContainer.appendChild(numButton);
        }
        let zeroButton = document.createElement('button');
        zeroButton.setAttribute('class', 'numButtons zero');
        zeroButton.setAttribute('id', '0');
        zeroButton.textContent = '0';
        let decimalButton = document.createElement('button');
        decimalButton.setAttribute('class', 'numButtons decimal');
        decimalButton.setAttribute('id', '.');
        decimalButton.textContent = '.';

        numContainer.appendChild(decimalButton);
        numContainer.appendChild(zeroButton);

        // Declare useful variables with initial values
        let displayValue = [];
        let firstNum = null;
        let operator = [];
        let secondNum = null;

        // function that resets variables
        function clear(){
            displayValue.length = 0;
            firstNum = null;
            operator.length = 0;
            secondNum = null;
        }
        // function that returns the result of displayed operation
        function equal(){
            console.log(operator);
            let oppIndex = displayValue.indexOf(operator[0]);
            if (oppIndex === -1){
                return
            }
            firstNum = displayValue.slice(0, oppIndex).join('');
            secondNum = displayValue.slice(oppIndex + 1).join('');
            let result = Math.round(operate(operator[0], +firstNum, +secondNum) * 10000) / 10000;
            clear();
            firstOpDone = true;
            displayValue.push(result);
        }

        function backspace(){
            if (displayValue.length === 1 && displayValue[0] !== 0){
                let num = displayValue[0].toString();
                clear();
                displayValue.push(Number(num.slice(0, -1)));
            } else {
                let value = displayValue.slice(0, -1);
                clear();
                displayValue = value;
            }
        };

        function decimal(){
            let firstOppIndex = displayValue.indexOf(operator[0]);
            if (firstNum === null && displayValue.includes('.') || 
                firstNum === null && displayValue.length !== 0 && displayValue[0].toString().includes('.') ||
                firstNum !== null && displayValue.slice(firstOppIndex).includes('.')) {
                    return;
            } else {
                displayValue.push('.')
            }
        }

        function operation(){
            if(operator.length > 1){
                let oppIndex = displayValue.indexOf(operator[0]);
                firstNum = displayValue.slice(0, oppIndex).join('');
                secondNum = displayValue.slice(oppIndex + 1, displayValue.length - 1).join('');
                let result = Math.round((operate(operator[0], +firstNum, +secondNum) + Number.EPSILON) * 1000) / 1000;
                let newOpp = operator[1];
                clear();
                displayValue.push(result);
                displayValue.push(newOpp);
                operator.push(newOpp);
            }
            let oppIndex = displayValue.indexOf(operator[0]);
            firstNum = displayValue.slice(0, oppIndex).join('');
        }

        // Get all buttons
        let calcButtons = btnContainer.querySelectorAll('button');
        // Add a click functionality for each button
        calcButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                switch(button.id){
                    case 'C':
                        clear();
                        break;
                    case '=':
                        equal();
                        break;
                    case '<':
                        backspace();
                        break;
                    case '.':
                        decimal();           
                        break; 
                    default:
                        if(displayValue[0] == 0 && displayValue.length === 1 && button.id !== '.'){
                            displayValue.length = 0;
                        }
                       displayValue.push(button.id);   
                }
                if (button.classList.contains('operators') && button.id !== '<') {
                    operator.push(button.id);
                    operation();
                }
                console.log(displayValue);
                displayEl.textContent = displayValue.join('');
            });
        });
        // add keyboard support
        document.addEventListener('keydown', (e) => {
            switch(e.key){
                case 'Backspace':
                    backspace();
                    break;
                case '=':
                    equal();
                    break;
                case 'C':
                case 'Clear':
                    clear();
                    break;
                case '.':
                    decimal();
                    break;
                case '+':
                case '-':
                case '*':
                case '/':
                    operator.push(e.key);
                    displayValue.push(e.key);
                    operation();
            }
            displayEl.textContent = displayValue.join('');
            if(isNaN(e.key)){
                return;
            } else {
                if(displayValue[0] == 0 && displayValue.length === 1 && e.key !== '.'){
                    displayValue.length = 0;
                }
                displayValue.push(e.key)
            }
            let result = displayValue.join('');
            displayEl.textContent = result;
        });

    </script>
</body>
</html>